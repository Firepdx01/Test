<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Roblox OAuth Login</title>
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <div class="login-container">
    <h1>Roblox Login</h1>
    <p>Click the button below to log in with your Roblox account.</p>
    <button id="loginBtn">Login with Roblox</button>
  </div>

  <script>
    // Generate a random state string
    function generateState() {
      const array = new Uint8Array(16);
      window.crypto.getRandomValues(array);
      return Array.from(array).map(b => ('0' + b.toString(16)).slice(-2)).join('');
    }

    // Generate a random code verifier
    function generateCodeVerifier() {
      const array = new Uint8Array(64);
      window.crypto.getRandomValues(array);
      return Array.from(array).map(b => ('0' + b.toString(16)).slice(-2)).join('');
    }

    // Compute the SHA256 hash and encode it using base64 URL encoding to create the code challenge
    async function generateCodeChallenge(verifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      const digest = await window.crypto.subtle.digest('SHA-256', data);
      let base64String = btoa(String.fromCharCode(...new Uint8Array(digest)));
      // Make the string URL-safe
      base64String = base64String.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      return base64String;
    }

    async function initiateOAuth() {
      const CLIENT_ID = "1016255010829551624"; // Replace with your actual Client ID
      const REDIRECT_URI = encodeURIComponent("http://localhost:8000/callback");
      const RESPONSE_TYPE = "code";
      const SCOPE = "openid";

      // Generate PKCE parameters and state
      const codeVerifier = generateCodeVerifier();
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      const state = generateState();

      console.log("Code Verifier:", codeVerifier);
      console.log("Code Challenge:", codeChallenge);
      console.log("State:", state);

      // Store codeVerifier securely (e.g., localStorage) if needed for later token exchange.
      localStorage.setItem("pkce_code_verifier", codeVerifier);
      localStorage.setItem("oauth_state", state);

      // Construct the OAuth URL with dynamically generated values.
      const authUrl = `https://auth.roblox.com/v2/oauth/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=${RESPONSE_TYPE}&scope=${SCOPE}&code_challenge=${codeChallenge}&code_challenge_method=S256&state=${state}`;
      
      // Redirect the user to the Roblox authorization page.
      window.location.href = authUrl;
    }

    document.getElementById("loginBtn").addEventListener("click", function() {
      initiateOAuth();
    });
  </script>
</body>
</html>
